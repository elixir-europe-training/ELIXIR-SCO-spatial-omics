<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ELIXIR Spatial Transcriptomics Course – ELIXIR-SCO-spatial-transcriptomics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/elixir_favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-c7e0d8a4bb88518e69f3d36b54b6fc10.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">ELIXIR-SCO-spatial-transcriptomics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../schedule.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../practicals.html"> 
<span class="menu-text">Practicals</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../presentations.html"> 
<span class="menu-text">Presentations</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/elixir-europe-training/ELIXIR-SCO-spatial-omics/"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">ELIXIR Spatial Transcriptomics Course</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../assets/ELIXIR1.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#practical-1a-imaging-based-spatial-transcriptomics-data-qc-and-normalization" id="toc-practical-1a-imaging-based-spatial-transcriptomics-data-qc-and-normalization" class="nav-link active" data-scroll-target="#practical-1a-imaging-based-spatial-transcriptomics-data-qc-and-normalization">Practical 1a: Imaging-based spatial transcriptomics data QC and normalization</a></li>
  <li><a href="#loading-packages" id="toc-loading-packages" class="nav-link" data-scroll-target="#loading-packages">Loading packages</a></li>
  <li><a href="#dataset-description-and-the-design-of-the-experiment" id="toc-dataset-description-and-the-design-of-the-experiment" class="nav-link" data-scroll-target="#dataset-description-and-the-design-of-the-experiment">Dataset description and the design of the experiment</a></li>
  <li><a href="#loading-data-and-primary-inspections" id="toc-loading-data-and-primary-inspections" class="nav-link" data-scroll-target="#loading-data-and-primary-inspections">Loading data and primary inspections</a>
  <ul class="collapse">
  <li><a href="#making-the-adata-object" id="toc-making-the-adata-object" class="nav-link" data-scroll-target="#making-the-adata-object">Making the adata object</a></li>
  </ul></li>
  <li><a href="#control-probes-and-decoding-metrics." id="toc-control-probes-and-decoding-metrics." class="nav-link" data-scroll-target="#control-probes-and-decoding-metrics.">Control probes and decoding metrics.</a></li>
  <li><a href="#explore-filtering-criteria" id="toc-explore-filtering-criteria" class="nav-link" data-scroll-target="#explore-filtering-criteria">Explore filtering criteria</a></li>
  <li><a href="#filtering-normalizing-and-cleaning-data" id="toc-filtering-normalizing-and-cleaning-data" class="nav-link" data-scroll-target="#filtering-normalizing-and-cleaning-data">Filtering, Normalizing and Cleaning data</a></li>
  <li><a href="#normaliation-and-scaling" id="toc-normaliation-and-scaling" class="nav-link" data-scroll-target="#normaliation-and-scaling">Normaliation and scaling</a>
  <ul class="collapse">
  <li><a href="#using-raw-counts" id="toc-using-raw-counts" class="nav-link" data-scroll-target="#using-raw-counts">Using raw counts</a></li>
  <li><a href="#lognorm" id="toc-lognorm" class="nav-link" data-scroll-target="#lognorm">Lognorm</a></li>
  <li><a href="#scaling" id="toc-scaling" class="nav-link" data-scroll-target="#scaling">Scaling</a></li>
  <li><a href="#pearson-residuals-normalization" id="toc-pearson-residuals-normalization" class="nav-link" data-scroll-target="#pearson-residuals-normalization">Pearson residuals normalization</a></li>
  <li><a href="#cell-size-normalization" id="toc-cell-size-normalization" class="nav-link" data-scroll-target="#cell-size-normalization">Cell size normalization</a></li>
  </ul></li>
  <li><a href="#dimensionality-reduction" id="toc-dimensionality-reduction" class="nav-link" data-scroll-target="#dimensionality-reduction">Dimensionality reduction</a></li>
  <li><a href="#systematic-filtering-of-suspected-false-positives" id="toc-systematic-filtering-of-suspected-false-positives" class="nav-link" data-scroll-target="#systematic-filtering-of-suspected-false-positives">Systematic Filtering of Suspected False Positives</a>
  <ul class="collapse">
  <li><a href="#second-approach" id="toc-second-approach" class="nav-link" data-scroll-target="#second-approach">Second approach</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ELIXIR Spatial Transcriptomics Course</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="practical-1a-imaging-based-spatial-transcriptomics-data-qc-and-normalization" class="level3">
<h3 class="anchored" data-anchor-id="practical-1a-imaging-based-spatial-transcriptomics-data-qc-and-normalization">Practical 1a: Imaging-based spatial transcriptomics data QC and normalization</h3>
<p>Date: 2025-01-21</p>
<p>Author(s): Rasool Saghaleyni, Åsa Björklund</p>
<p>Author(s) email: <a href="mailto:rasool.saghaleyni@scilifelab.se" class="email">rasool.saghaleyni@scilifelab.se</a>, <a href="mailto:asa.bjorklund@scilifelab.se" class="email">asa.bjorklund@scilifelab.se</a></p>
<p>⚠️ Note: The proper environment for this notebook is <code>p1_qc_normalization</code>. It can be activated by selecting the kernel in the Jupyter notebook.</p>
</section>
<section id="loading-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-packages">Loading packages</h2>
<div id="cell-3" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> LinearSegmentedColormap</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> squidpy <span class="im">as</span> sq</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.sparse <span class="im">as</span> sp</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> gaussian_kde</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> find_peaks, argrelextrema</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.sparse <span class="im">import</span> issparse, csr_matrix</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diptest <span class="im">import</span> diptest</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point, Polygon, MultiPoint</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial <span class="im">import</span> ConvexHull</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'./custom'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tenx_method_nb_helper_functions <span class="im">as</span> hf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dataset-description-and-the-design-of-the-experiment" class="level2">
<h2 class="anchored" data-anchor-id="dataset-description-and-the-design-of-the-experiment">Dataset description and the design of the experiment</h2>
<p>Before starting the analysis, please make that you know about the biological background, experimental design and the data structure for the datset that we will do the analysis on it. Here you can find good information about this: https://pages.10xgenomics.com/rs/446-PBO-704/images/10x_LIT000210_App-Note_Xenium-In-Situ_Letter_Digital.pdf</p>
</section>
<section id="loading-data-and-primary-inspections" class="level2">
<h2 class="anchored" data-anchor-id="loading-data-and-primary-inspections">Loading data and primary inspections</h2>
<p>Making adata object considering the transcripts that should be used for the analysis. Running analysis on the transcripts that are only in the nucleus.</p>
<p>Data was downloaded from 10x at https://cf.10xgenomics.com/samples/xenium/1.4.0/Xenium_V1_FFPE_TgCRND8_17_9_months/Xenium_V1_FFPE_TgCRND8_17_9_months_outs.zip and unzipped in folder <code>data/</code>.</p>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sample_path <span class="op">=</span> <span class="st">"../data/Xenium_V1_FFPE_TgCRND8_17_9_months_outs"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_path = "/data/raw_data/Xenium_V1_FFPE_TgCRND8_17_9_months_outs"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>transcripts_csv_path <span class="op">=</span> os.path.join(sample_path, <span class="st">"transcripts.csv.gz"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>transcripts_df <span class="op">=</span> pd.read_csv(transcripts_csv_path, compression<span class="op">=</span><span class="st">'gzip'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>nucleus_boundaries_gz_path <span class="op">=</span> os.path.join(sample_path, <span class="st">"nucleus_boundaries.csv.gz"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>nucleus_df <span class="op">=</span> pd.read_csv(nucleus_boundaries_gz_path, compression<span class="op">=</span><span class="st">'gzip'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(os.path.join(sample_path, <span class="st">"cells.csv"</span>)):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    hf.decompress_file(os.path.join(sample_path, <span class="st">"cells.csv.gz"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="making-the-adata-object" class="level3">
<h3 class="anchored" data-anchor-id="making-the-adata-object">Making the adata object</h3>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> hf.create_adata(sample_path, nucleus_genes_only <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>adata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>AnnData object with n_obs × n_vars = 62268 × 347
    obs: 'cell_id', 'x_centroid', 'y_centroid', 'transcript_counts', 'control_probe_counts', 'control_codeword_counts', 'unassigned_codeword_counts', 'total_counts', 'cell_area', 'nucleus_area'
    var: 'gene_ids', 'feature_types', 'genome'
    obsm: 'spatial'</code></pre>
</div>
</div>
<p>The <code>AnnData</code> object, <code>adata</code>, contains a structured dataset with cells as observations (<code>n_obs = 62268</code>) and genes as variables (<code>n_vars = 347</code>). Here’s a breakdown of the main components within <code>adata</code>:</p>
<div id="cell-11" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>adata.obs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x_centroid</th>
<th data-quarto-table-cell-role="th">y_centroid</th>
<th data-quarto-table-cell-role="th">transcript_counts</th>
<th data-quarto-table-cell-role="th">control_probe_counts</th>
<th data-quarto-table-cell-role="th">control_codeword_counts</th>
<th data-quarto-table-cell-role="th">unassigned_codeword_counts</th>
<th data-quarto-table-cell-role="th">total_counts</th>
<th data-quarto-table-cell-role="th">cell_area</th>
<th data-quarto-table-cell-role="th">nucleus_area</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">aaabiggh-1</td>
<td>aaabiggh-1</td>
<td>831.785336</td>
<td>755.803772</td>
<td>554</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>554</td>
<td>509.091563</td>
<td>65.386250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">aaacfoel-1</td>
<td>aaacfoel-1</td>
<td>821.733453</td>
<td>768.910446</td>
<td>291</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>291</td>
<td>275.498281</td>
<td>36.982969</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">aaaeefil-1</td>
<td>aaaeefil-1</td>
<td>831.932053</td>
<td>780.367651</td>
<td>220</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>221</td>
<td>261.635312</td>
<td>15.849844</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">aaaehidd-1</td>
<td>aaaehidd-1</td>
<td>853.614108</td>
<td>774.764157</td>
<td>1029</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1029</td>
<td>818.547344</td>
<td>129.056563</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">aaagcbkg-1</td>
<td>aaagcbkg-1</td>
<td>821.639603</td>
<td>799.171515</td>
<td>453</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>454</td>
<td>522.232031</td>
<td>96.002188</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">oindmjog-1</td>
<td>oindmjog-1</td>
<td>5068.380664</td>
<td>4446.804883</td>
<td>35</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>35</td>
<td>229.709844</td>
<td>15.985312</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">oinecaba-1</td>
<td>oinecaba-1</td>
<td>5072.841504</td>
<td>4459.385132</td>
<td>124</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>124</td>
<td>359.353438</td>
<td>18.423750</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">oinehfmf-1</td>
<td>oinehfmf-1</td>
<td>5251.196240</td>
<td>4366.193091</td>
<td>15</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>15</td>
<td>686.329844</td>
<td>24.745625</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">oinemiil-1</td>
<td>oinemiil-1</td>
<td>5248.493506</td>
<td>4382.190356</td>
<td>22</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>22</td>
<td>333.478906</td>
<td>20.681562</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">oingfoec-1</td>
<td>oingfoec-1</td>
<td>5272.023315</td>
<td>4387.369629</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>750.948438</td>
<td>9.798906</td>
</tr>
</tbody>
</table>

<p>62268 rows × 10 columns</p>
</div>
</div>
</div>
<p><code>obs</code> (Observations): This table contains metadata about each cell, where each row corresponds to a cell, and each column holds information about a specific attribute:</p>
<ul>
<li><p><code>cell_id</code>: Unique identifier for each cell.</p></li>
<li><p><code>x_centroid</code> and <code>y_centroid</code>: Coordinates of each cell’s center in the spatial layout, indicating where each cell is located within the tissue.</p></li>
<li><p><code>transcript_counts</code>: Total transcript counts for each cell, showing the overall gene expression level.</p></li>
<li><p><code>control_probe_counts</code> and <code>control_codeword_counts</code>: Counts related to control probes and codewords, which are often used for quality control in spatial transcriptomics.</p></li>
<li><p><code>unassigned_codeword_counts</code> and <code>deprecated_codeword_counts</code>: Counts of unassigned or deprecated codewords, indicating low-confidence or outdated identifiers.</p></li>
<li><p><code>total_counts</code>: Total counts across all measured attributes, representing the cell’s total signal.</p></li>
<li><p><code>cell_area</code> and <code>nucleus_area</code>: Physical measurements of the cell and its nucleus area, in pixels or micrometers.</p></li>
</ul>
<div id="cell-13" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>adata.var</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">gene_ids</th>
<th data-quarto-table-cell-role="th">feature_types</th>
<th data-quarto-table-cell-role="th">genome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010300C02Rik</td>
<td>ENSMUSG00000026090</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Abca7</td>
<td>ENSMUSG00000035722</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Acsbg1</td>
<td>ENSMUSG00000032281</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Acta2</td>
<td>ENSMUSG00000035783</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Acvrl1</td>
<td>ENSMUSG00000000530</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Vwc2l</td>
<td>ENSMUSG00000045648</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Wfs1</td>
<td>ENSMUSG00000039474</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Zfp366</td>
<td>ENSMUSG00000050919</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Zfp536</td>
<td>ENSMUSG00000043456</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Zfpm2</td>
<td>ENSMUSG00000022306</td>
<td>Gene Expression</td>
<td>Unknown</td>
</tr>
</tbody>
</table>

<p>347 rows × 3 columns</p>
</div>
</div>
</div>
<p><code>var</code> (Variables): This table contains metadata about each gene, where each row is a gene and each column is an attribute:</p>
<ul>
<li><p><code>gene_ids</code>: Unique identifiers for each gene, often in Ensembl or another standardized format.</p></li>
<li><p><code>feature_types</code>: Type of feature associated with each gene, such as “gene” or “transcript.”</p></li>
<li><p><code>genome</code>: Information about the genome source of each gene, like “human” or “mouse.”</p></li>
</ul>
<p><code>obsm</code> (Multi-dimensional Observations): This slot contains multi-dimensional data related to cells. Here, <code>spatial</code> stores spatial coordinates for each cell, allowing visualization and spatial analysis of cells in their tissue context.</p>
<div id="cell-15" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'total_counts'</span>] <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'total_counts'</span>], kde<span class="op">=</span><span class="st">'True'</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Transcript Counts per Cell"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Total Transcript Counts per Cell"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We calculate the total transcript counts for each cell by summing gene expression values across all genes and the number of genes detected in each cell. The resulting distributions gives us an overview of the data quality and cellular diversity in terms of RNA content.</p>
<p>These provide a measure of each cell’s transcriptional activity or RNA content. High total counts typically indicate cells with higher transcriptional activity, while very low total counts may suggest low-quality cells or empty spots with minimal RNA. Examining this distribution helps us assess data quality and identify potential outliers:</p>
<ul>
<li>Cells with Very Low Counts: These may represent low-quality cells or background noise, which could be filtered out in subsequent steps to improve analysis accuracy.</li>
<li>Cells with Very High Counts: High total counts may indicate cell types with naturally high transcriptional activity or potential doublets (two cells counted as one).</li>
</ul>
<p>This plot provides a quick check of the dataset’s quality and helps inform any initial filtering steps. A typical goal is to ensure the data has a reasonable distribution of RNA counts per cell, without excessive noise or artifacts that might skew downstream analysis.</p>
<div id="cell-17" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'n_genes'</span>] <span class="op">=</span> (adata.X <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'n_genes'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of Genes Detected per Cell"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Genes Detected per Cell"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now lets find genes with the highest expression across the whole dataset. We calculate the mean expression level of each gene across all cells and identify the top 10 most highly expressed genes, then plot them to understand which genes dominate the transcriptional landscape. This helps us quickly identify genes with the highest abundance, which are often either essential housekeeping genes or specific markers that define particular cell types. Examining the top expressed genes serves both technical and biological purposes: it allows us to check for any potential technical artifacts (e.g., genes with unusually high background expression) and offers biological insight by highlighting key genes likely involved in core cellular functions or distinguishing cell types.</p>
<div id="cell-19" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate mean expression for each gene</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mean_expression <span class="op">=</span> adata.X.mean(axis<span class="op">=</span><span class="dv">0</span>).A1</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>top_genes_idx <span class="op">=</span> mean_expression.argsort()[::<span class="op">-</span><span class="dv">1</span>][:<span class="dv">10</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>top_genes <span class="op">=</span> adata.var_names[top_genes_idx]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>top_expression <span class="op">=</span> mean_expression[top_genes_idx]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>top_genes, y<span class="op">=</span>top_expression)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Genes"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Expression"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Top 10 Most Expressed Genes"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can also look into the distributions of cell and nucleus areas to assess segmentation quality and examine cell size diversity across the dataset. These distributions provide an overview of the range of cell and nucleus sizes, helping to identify segmentation artifacts or inconsistencies, such as unusually small areas (which may indicate partial cells or segmentation errors) or large areas (potentially indicating doublets or merged cells).</p>
<div id="cell-21" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#distribution of cell and nucleus areas</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'cell_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Cell Area"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Cell Areas"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'nucleus_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Nucleus Area"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Nucleus Areas"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Cell Area vs Nucleus Area</p>
<div id="cell-23" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'cell_area'</span>], adata.obs[<span class="st">'nucleus_area'</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Cell Area"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nucleus Area"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cell Area vs Nucleus Area"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Calculate cell-to-nucleus area ratio and plot it. This ratio provides a measure of the relative size of the nucleus compared to the whole cell, which can be informative for understanding cell morphology and the distribution of nuclear material within cells. A high ratio may indicate cells with large nuclei relative to their overall size, which could be relevant for cell type classification or biological interpretation. Examining this ratio helps identify potential outliers or unusual cell morphologies that may require further investigation or filtering.</p>
<div id="cell-25" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'area_ratio'</span>] <span class="op">=</span> adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">/</span> adata.obs[<span class="st">'cell_area'</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'area_ratio'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Nucleus-to-Cell Area Ratio"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Nucleus-to-Cell Area Ratios"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Scatter plot of Cell Area vs Total Counts</p>
<div id="cell-27" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'cell_area'</span>], adata.obs[<span class="st">'total_counts'</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Cell Area"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Transcript Counts"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cell Area vs Total Transcript Counts"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Spatial plot of cell and nucleus areas.</p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cell area</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'cell_area'</span>, spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="st">"Spatial Distribution of Cell Area"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#nucleus area</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'nucleus_area'</span>, spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="st">"Spatial Distribution of Nucleus Area"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking to spatial distibution of one of the genes. For example the gene “MALL”</p>
<div id="cell-31" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'Cst3'</span>], spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="st">"Cst3 Gene Expression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#filter cells with nucleus area &lt; 5</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>initial_cells_count <span class="op">=</span> adata.n_obs</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">&gt;=</span> <span class="dv">5</span>].copy()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>filtered_cells_count <span class="op">=</span> adata.n_obs</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filtered out </span><span class="sc">{</span>initial_cells_count <span class="op">-</span> filtered_cells_count<span class="sc">}</span><span class="ss"> cells with nucleus_area &lt; 5. Remaining cells: </span><span class="sc">{</span>filtered_cells_count<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered out 314 cells with nucleus_area &lt; 5. Remaining cells: 61954</code></pre>
</div>
</div>
<p>Plot distribution of total transcript counts per cell and distribution of Nucleus area after filtering</p>
<div id="cell-34" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'total_counts'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Transcript Counts per Cell"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Total Transcript Counts per Cell After Filtering"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'nucleus_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Nucleus Area"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Nucleus Area After Filtering"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-17-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="control-probes-and-decoding-metrics." class="level2">
<h2 class="anchored" data-anchor-id="control-probes-and-decoding-metrics.">Control probes and decoding metrics.</h2>
<p>we can also look into the control probe counts and their spatial distribution to assess background noise and technical quality in the dataset. First, we plot the distribution of control probe counts across cells to understand how frequently control probes are detected. This distribution provides insights into potential technical noise or background signals, as higher-than-expected control counts may suggest artifacts or contamination. Next, we create a spatial plot of control probe counts, which allows us to see if any regions in the tissue exhibit unexpectedly high control counts, possibly indicating localized technical issues.</p>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot distribution of control probe counts</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'control_probe_counts'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Control Probe Counts"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Control Probe Counts"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#spatial plot of control probe counts</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'control_probe_counts'</span>, spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="st">"Spatial Distribution of Control Probe Counts"</span>, cmap <span class="op">=</span> <span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'control_codeword_counts'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Spatial Distribution of Control codeword Counts"</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'unassigned_codeword_counts'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Spatial Distribution of Unassigned codeword Counts"</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-19-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.crosstab(adata.obs[<span class="st">'control_probe_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>, adata.obs[<span class="st">'control_codeword_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># not always in the same cells!</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.crosstab(adata.obs[<span class="st">'control_codeword_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>, adata.obs[<span class="st">'unassigned_codeword_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>control_codeword_counts  False  True 
control_probe_counts                 
False                    60073    614
True                      1253     14
unassigned_codeword_counts  False  True 
control_codeword_counts                 
False                       57963   3363
True                          576     52</code></pre>
</div>
</div>
<p>How does the control probes etc correlate to other quality measures?</p>
<div id="cell-41" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'ctrl_probe'</span>] <span class="op">=</span> (adata.obs[<span class="st">'control_probe_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>).astype(<span class="st">"category"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'ctrl_code'</span>] <span class="op">=</span> (adata.obs[<span class="st">'control_codeword_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>).astype(<span class="st">"category"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'unass_code'</span>] <span class="op">=</span> (adata.obs[<span class="st">'unassigned_codeword_counts'</span>]<span class="op">&gt;</span><span class="dv">0</span>).astype(<span class="st">"category"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'cell_area'</span>,<span class="st">'nucleus_area'</span>,<span class="st">'total_counts'</span>,<span class="st">'n_genes'</span>], groupby<span class="op">=</span><span class="st">'ctrl_probe'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'cell_area'</span>,<span class="st">'nucleus_area'</span>,<span class="st">'total_counts'</span>,<span class="st">'n_genes'</span>], groupby<span class="op">=</span><span class="st">'ctrl_code'</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'cell_area'</span>,<span class="st">'nucleus_area'</span>,<span class="st">'total_counts'</span>,<span class="st">'n_genes'</span>], groupby<span class="op">=</span><span class="st">'unass_code'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-21-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Just seems to be larger cells with larger number of counts and genes.</p>
</section>
<section id="explore-filtering-criteria" class="level2">
<h2 class="anchored" data-anchor-id="explore-filtering-criteria">Explore filtering criteria</h2>
<div id="cell-44" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'cell_area'</span>,<span class="st">'nucleus_area'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, color_map <span class="op">=</span> <span class="st">"viridis_r"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'total_counts'</span>,<span class="st">'n_genes'</span>], spot_size<span class="op">=</span><span class="dv">15</span>,  color_map <span class="op">=</span> <span class="st">"viridis_r"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>All top region of the section is messed up, low counts and low number of features. Needs to be reomoved? Napari?</p>
<p>Also, bunch of “cells” outside of the tissue.</p>
<div id="cell-46" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'total_counts'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'min10'</span>] <span class="op">=</span> adata.obs[<span class="st">'total_counts'</span>] <span class="op">&lt;</span> <span class="dv">10</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'min10'</span>].value_counts())</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'min30'</span>] <span class="op">=</span> adata.obs[<span class="st">'total_counts'</span>] <span class="op">&lt;</span> <span class="dv">30</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'min30'</span>].value_counts())</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'max600'</span>] <span class="op">=</span> adata.obs[<span class="st">'total_counts'</span>] <span class="op">&gt;</span> <span class="dv">600</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'max600'</span>].value_counts())</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'min10'</span>,<span class="st">'min30'</span>,<span class="st">'max600'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"lightgray"</span>,<span class="st">"blue"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>min10
False    59765
True      2189
Name: count, dtype: int64
min30
False    58588
True      3366
Name: count, dtype: int64
max600
False    61629
True       325
Name: count, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-23-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'n_genes'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Gmin5'</span>] <span class="op">=</span> adata.obs[<span class="st">'n_genes'</span>] <span class="op">&lt;</span> <span class="dv">5</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Gmin5'</span>].value_counts())</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Gmax150'</span>] <span class="op">=</span> adata.obs[<span class="st">'n_genes'</span>] <span class="op">&gt;</span> <span class="dv">150</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Gmax150'</span>].value_counts())</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'Gmin5'</span>,<span class="st">'Gmax150'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"lightgray"</span>,<span class="st">"blue"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Gmin5
False    60082
True      1872
Name: count, dtype: int64
Gmax150
False    61924
True        30
Name: count, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-24-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-24-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'cell_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Amin10'</span>] <span class="op">=</span> adata.obs[<span class="st">'cell_area'</span>] <span class="op">&lt;</span> <span class="dv">10</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Amin10'</span>].value_counts())</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Amin20'</span>] <span class="op">=</span> adata.obs[<span class="st">'cell_area'</span>] <span class="op">&lt;</span> <span class="dv">20</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Amin20'</span>].value_counts())</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Amax1000'</span>] <span class="op">=</span> adata.obs[<span class="st">'cell_area'</span>] <span class="op">&gt;</span> <span class="dv">1000</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Amax1000'</span>].value_counts())</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'Amin10'</span>,<span class="st">'Amin20'</span>,<span class="st">'Amax1000'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"lightgray"</span>,<span class="st">"blue"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Amin10
False    61946
True         8
Name: count, dtype: int64
Amin20
False    61761
True       193
Name: count, dtype: int64
Amax1000
False    61709
True       245
Name: count, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-25-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-25-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'nucleus_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Nmin10'</span>] <span class="op">=</span> adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">&lt;</span> <span class="dv">10</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Nmin10'</span>].value_counts())</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Nmin7'</span>] <span class="op">=</span> adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">&lt;</span> <span class="dv">7</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Nmin7'</span>].value_counts())</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Nmin6'</span>] <span class="op">=</span> adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">&lt;</span> <span class="dv">6</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Nmin6'</span>].value_counts())</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'Nmax125'</span>] <span class="op">=</span> adata.obs[<span class="st">'nucleus_area'</span>] <span class="op">&gt;</span> <span class="dv">125</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'Nmax125'</span>].value_counts())</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'Nmin10'</span>,<span class="st">'Nmin6'</span>,<span class="st">'Nmin7'</span>,<span class="st">'Nmax125'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"lightgray"</span>,<span class="st">"blue"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nmin10
False    57829
True      4125
Name: count, dtype: int64
Nmin7
False    60315
True      1639
Name: count, dtype: int64
Nmin6
False    61184
True       770
Name: count, dtype: int64
Nmax125
False    61702
True       252
Name: count, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-26-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-50" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>adata.obs.sort_values(by<span class="op">=</span><span class="st">"nucleus_area"</span>).head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x_centroid</th>
<th data-quarto-table-cell-role="th">y_centroid</th>
<th data-quarto-table-cell-role="th">transcript_counts</th>
<th data-quarto-table-cell-role="th">control_probe_counts</th>
<th data-quarto-table-cell-role="th">control_codeword_counts</th>
<th data-quarto-table-cell-role="th">unassigned_codeword_counts</th>
<th data-quarto-table-cell-role="th">total_counts</th>
<th data-quarto-table-cell-role="th">cell_area</th>
<th data-quarto-table-cell-role="th">nucleus_area</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">max600</th>
<th data-quarto-table-cell-role="th">Gmin5</th>
<th data-quarto-table-cell-role="th">Gmax150</th>
<th data-quarto-table-cell-role="th">Amin10</th>
<th data-quarto-table-cell-role="th">Amin20</th>
<th data-quarto-table-cell-role="th">Amax1000</th>
<th data-quarto-table-cell-role="th">Nmin10</th>
<th data-quarto-table-cell-role="th">Nmin7</th>
<th data-quarto-table-cell-role="th">Nmin6</th>
<th data-quarto-table-cell-role="th">Nmax125</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">hkcipmfi-1</td>
<td>hkcipmfi-1</td>
<td>1896.213452</td>
<td>3830.822583</td>
<td>87</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>87.0</td>
<td>81.461875</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">hdjcjgek-1</td>
<td>hdjcjgek-1</td>
<td>3327.305493</td>
<td>1251.938251</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18.0</td>
<td>36.982969</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">hdhkdpgn-1</td>
<td>hdhkdpgn-1</td>
<td>3440.780078</td>
<td>1249.603552</td>
<td>73</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>73.0</td>
<td>167.845781</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kjbhfghi-1</td>
<td>kjbhfghi-1</td>
<td>4029.808911</td>
<td>4098.354688</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18.0</td>
<td>77.668750</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kjbilgog-1</td>
<td>kjbilgog-1</td>
<td>4026.586133</td>
<td>4134.333179</td>
<td>77</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>77.0</td>
<td>223.026719</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">imkjpnnj-1</td>
<td>imkjpnnj-1</td>
<td>1149.841339</td>
<td>651.571744</td>
<td>90</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>90.0</td>
<td>65.973281</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">dicdnime-1</td>
<td>dicdnime-1</td>
<td>2213.888708</td>
<td>785.633875</td>
<td>335</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>335.0</td>
<td>687.232969</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bohkadnc-1</td>
<td>bohkadnc-1</td>
<td>4163.014038</td>
<td>1619.668774</td>
<td>59</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>59.0</td>
<td>214.221250</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">laldefaj-1</td>
<td>laldefaj-1</td>
<td>5488.850513</td>
<td>2387.367151</td>
<td>77</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>77.0</td>
<td>180.895938</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">madmmblf-1</td>
<td>madmmblf-1</td>
<td>2708.154578</td>
<td>797.708554</td>
<td>69</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>69.0</td>
<td>115.690313</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">oaggdhce-1</td>
<td>oaggdhce-1</td>
<td>2642.590234</td>
<td>2067.187549</td>
<td>53</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>53.0</td>
<td>69.134219</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mbegkkhi-1</td>
<td>mbegkkhi-1</td>
<td>2826.654041</td>
<td>317.760287</td>
<td>15</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>15.0</td>
<td>11.469687</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mjkfcnjk-1</td>
<td>mjkfcnjk-1</td>
<td>5086.753198</td>
<td>2939.776050</td>
<td>82</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>82.0</td>
<td>248.720625</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cjkdglik-1</td>
<td>cjkdglik-1</td>
<td>4837.046606</td>
<td>2266.345081</td>
<td>161</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>161.0</td>
<td>457.613437</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">gobpaadh-1</td>
<td>gobpaadh-1</td>
<td>1828.043079</td>
<td>2896.392017</td>
<td>161</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>161.0</td>
<td>209.163750</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kedbcdbd-1</td>
<td>kedbcdbd-1</td>
<td>957.122827</td>
<td>1123.840387</td>
<td>73</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>73.0</td>
<td>93.247656</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kkamiafh-1</td>
<td>kkamiafh-1</td>
<td>3918.152612</td>
<td>3481.532764</td>
<td>77</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>77.0</td>
<td>140.300469</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">feoednoe-1</td>
<td>feoednoe-1</td>
<td>4181.003491</td>
<td>3960.628540</td>
<td>26</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>26.0</td>
<td>21.900781</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">cjhlfijo-1</td>
<td>cjhlfijo-1</td>
<td>4890.426025</td>
<td>2503.740576</td>
<td>32</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>32.0</td>
<td>53.239219</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">nbcppddc-1</td>
<td>nbcppddc-1</td>
<td>3231.211084</td>
<td>1264.438501</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>6.0</td>
<td>20.862188</td>
<td>5.012344</td>
<td>...</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>20 rows × 27 columns</p>
</div>
</div>
</div>
<p>Many cells with exact same nucleus area - at 5.012344, Clearly varying cell area for same cells.</p>
<div id="cell-52" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'cell_area'</span>], adata.obs[<span class="st">'nucleus_area'</span>], c<span class="op">=</span>adata.obs[<span class="st">'total_counts'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-53" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'cell_area'</span>], adata.obs[<span class="st">'total_counts'</span>], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-54" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'total_counts'</span>], adata.obs[<span class="st">'n_genes'</span>], c<span class="op">=</span>adata.obs[<span class="st">'cell_area'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Look at gene detection</p>
<div id="cell-56" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'n_cell'</span>] <span class="op">=</span> adata.X.getnnz(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'n_count'</span>] <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>).A1</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_cell'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_count'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-57" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_cell'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_count'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.var[<span class="st">'n_count'</span>], adata.var[<span class="st">'n_cell'</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Most genes are detected in around 5K of the 61K cells. A few are in pretty much every cell. Lowest number is 112 cells.</p>
<p>The few genes with extremely high counts will effect normalization a great deal.</p>
<div id="cell-59" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'n_cell'</span>].<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>112</code></pre>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/preprocessing/_normalization.py:234: UserWarning: Some cells have zero counts
  warn(UserWarning("Some cells have zero counts"))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-34-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="filtering-normalizing-and-cleaning-data" class="level2">
<h2 class="anchored" data-anchor-id="filtering-normalizing-and-cleaning-data">Filtering, Normalizing and Cleaning data</h2>
<p>Run filtering with:</p>
<p>Nuclei size &lt; 7</p>
<p>Area &lt; 20, &gt;1000</p>
<p>Total counts &lt; 30, &gt; 600</p>
<p>Number of genes &lt;4, &gt; 150</p>
<p>Filter out the cells that have nuclei smaller than 7 microns.</p>
<p>What do you think could be a good cutoff for filtering out lowly expressed genes and cells with low transcript count? Lets removes low-quality cells and genes from the dataset, which helps reduce noise and computational load in downstream analyses. This filtering step ensures that the dataset is focused on cells and genes with a minimum level of expression, which are more likely to be biologically relevant.</p>
<div id="cell-65" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell and gene filtering</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>initial_cells_count <span class="op">=</span> adata.n_obs</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>initial_genes_count <span class="op">=</span> adata.n_vars</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>adata_full <span class="op">=</span> adata.copy()</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, min_counts<span class="op">=</span><span class="dv">30</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, max_counts<span class="op">=</span><span class="dv">600</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, min_genes<span class="op">=</span><span class="dv">5</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, max_genes<span class="op">=</span><span class="dv">150</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># sc.pp.filter_genes(adata, min_cells=5, inplace=True) - no genes have less than 5 cells.</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'cell_area'</span>]<span class="op">&gt;</span><span class="dv">20</span>,:]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'cell_area'</span>]<span class="op">&lt;</span><span class="dv">1000</span>,:]</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'nucleus_area'</span>]<span class="op">&gt;</span><span class="dv">7</span>,:]</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>filtered_cells_count <span class="op">=</span> adata.n_obs</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>filtered_genes_count <span class="op">=</span> adata.n_vars</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filtered </span><span class="sc">{</span>initial_cells_count <span class="op">-</span> filtered_cells_count<span class="sc">}</span><span class="ss"> (out of intial </span><span class="sc">{</span>initial_cells_count<span class="sc">}</span><span class="ss"> cells)"</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filtered </span><span class="sc">{</span>initial_genes_count <span class="op">-</span> filtered_genes_count<span class="sc">}</span><span class="ss"> (out of intial </span><span class="sc">{</span>initial_genes_count<span class="sc">}</span><span class="ss"> genes)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered 5055 (out of intial 61954 cells)
Filtered 0 (out of intial 347 genes)</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'total_counts'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Transcript Counts per Cell"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Total Transcript Counts per Cell After Filtering"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.obs[<span class="st">'nucleus_area'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Nucleus Area"</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Nucleus Area After Filtering"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-36-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-67" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.obs[<span class="st">'cell_area'</span>], adata.obs[<span class="st">'total_counts'</span>], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># now no gene is 100% of the expression for a cell, but still have genes that make up around 40%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/preprocessing/_normalization.py:207: UserWarning: Received a view of an AnnData. Making a copy.
  view_to_actual(adata)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-38-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-69" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check again n_cell vs total counts after filtering genes, no gene should now be 100%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'n_cell2'</span>] <span class="op">=</span> adata.X.getnnz(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'n_count2'</span>] <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>).A1</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_cell2'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(adata.var[<span class="st">'n_count2'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">100</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>plt.scatter(adata.var[<span class="st">'n_count2'</span>], adata.var[<span class="st">'n_cell2'</span>], alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-70" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>adata_full.obs[<span class="st">'kept'</span>] <span class="op">=</span> adata_full.obs_names.isin(adata.obs_names)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata_full, color<span class="op">=</span>[<span class="st">'kept'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"lightgray"</span>,<span class="st">"blue"</span>])</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata_full, color<span class="op">=</span>[<span class="st">'kept'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, palette <span class="op">=</span> [<span class="st">"blue"</span>,<span class="st">"lightgray"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-40-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="normaliation-and-scaling" class="level2">
<h2 class="anchored" data-anchor-id="normaliation-and-scaling">Normaliation and scaling</h2>
<p>Normalization adjusts for cell-specific technical differences, and log transformation makes the data easier to analyze by reducing the effects of extreme values. This normalization and transformation make the dataset more appropriate for dimensionality reduction, clustering, and other analyses.</p>
<section id="using-raw-counts" class="level3">
<h3 class="anchored" data-anchor-id="using-raw-counts">Using raw counts</h3>
<p>Test running pca and umap without normalization.</p>
<div id="cell-73" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP raw counts'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
/var/folders/8l/yj6nz8296zd7wwj0xy6pw3880000gn/T/ipykernel_80568/183271786.py:3: FutureWarning: In the future, the default backend for leiden will be igraph instead of leidenalg.

 To achieve the future defaults please pass: flavor="igraph" and n_iterations=2.  directed must also be False to work with igraph's implementation.
  sc.tl.leiden(adata)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-41-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-74" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_umap_counts'</span>] <span class="op">=</span> adata.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'leiden_counts'</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lognorm" class="level3">
<h3 class="anchored" data-anchor-id="lognorm">Lognorm</h3>
<div id="cell-76" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'raw'</span>] <span class="op">=</span> adata.X.copy()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>sc.pp.normalize_total(adata, target_sum<span class="op">=</span><span class="fl">1e4</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Comparing the effect of normalization</p>
<div id="cell-78" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>original_counts <span class="op">=</span> adata.layers[<span class="st">'raw'</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>normalized_counts <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co">#plt distributions</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>sns.histplot(original_counts.A1, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Before Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>sns.histplot(normalized_counts.A1, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"After Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Expression per Cell"</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Effect of Normalization on Expression Distribution"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>How the normalization and scaling of the data affects the distribution of gene expression values in the dataset. We can have a look at the distribution of gene expression values before and after normalization and scaling for Cst3 gene.</p>
<div id="cell-80" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>gene_name <span class="op">=</span> <span class="st">"Cst3"</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gene_name <span class="kw">in</span> adata.var_names:</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#extract Cst3 expression values before normalization</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    original_mall_expression <span class="op">=</span> adata[:, gene_name].layers[<span class="st">'raw'</span>].toarray().flatten()</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#and after normalization</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    normalized_mall_expression <span class="op">=</span> adata[:, gene_name].X.toarray().flatten()</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#plt distributions</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    sns.histplot(original_mall_expression, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Before Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    sns.histplot(normalized_mall_expression, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"After Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="ss">f"</span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Effect of Normalization and Scaling on </span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-81" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a more intermediate expression gene.</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>gene_name <span class="op">=</span> <span class="st">"Sorl1"</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gene_name <span class="kw">in</span> adata.var_names:</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    original_mall_expression <span class="op">=</span> adata[:, gene_name].layers[<span class="st">'raw'</span>].toarray().flatten()</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    normalized_mall_expression <span class="op">=</span> adata[:, gene_name].X.toarray().flatten()</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    sns.histplot(original_mall_expression, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Before Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    sns.histplot(normalized_mall_expression, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"After Normalization"</span>, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="ss">f"</span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Effect of Normalization and Scaling on </span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-82" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a lowly expression gene.</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>gene_name <span class="op">=</span> <span class="st">"Th"</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gene_name <span class="kw">in</span> adata.var_names:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    original_mall_expression <span class="op">=</span> adata[:, gene_name].layers[<span class="st">'raw'</span>].toarray().flatten()</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    normalized_mall_expression <span class="op">=</span> adata[:, gene_name].X.toarray().flatten()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    sns.histplot(original_mall_expression, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Before Normalization"</span>,  bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    sns.histplot(normalized_mall_expression, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"After Normalization"</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="ss">f"</span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Number of Cells"</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Effect of Normalization and Scaling on </span><span class="sc">{</span>gene_name<span class="sc">}</span><span class="ss"> Expression"</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-83" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Cst3'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">"Cst3 vs Total counts"</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Cd69'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">"Cd69 vs Total counts"</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Sorl1'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">"Sorl1 vs Total counts"</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="co">#adata.var.index.tolist().index('Cst3')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>Text(0.5, 1.0, 'Sorl1 vs Total counts')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-48-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-84" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-85" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP lognorm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-86" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_umap_lognorm'</span>] <span class="op">=</span> adata.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'leiden_lognorm'</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># save the lognorm as its own layer</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'lognorm'</span>] <span class="op">=</span> adata.X.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scaling" class="level3">
<h3 class="anchored" data-anchor-id="scaling">Scaling</h3>
<p>Should the data be scaled before running PCA? Get more distinct clusters, but is it closer to biological truth?</p>
<div id="cell-88" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata, max_value<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-89" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP Scaled'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-53-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-90" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Cst3'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">"Cst3 vs Total counts"</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Cd69'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">"Cd69 vs Total counts"</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Sorl1'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">"Sorl1 vs Total counts"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>Text(0.5, 1.0, 'Sorl1 vs Total counts')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-54-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-91" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_umap_scaled'</span>] <span class="op">=</span> adata.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'leiden_scaled'</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># save the lognorm as its own layer</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'scaled'</span>] <span class="op">=</span> adata.X.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pearson-residuals-normalization" class="level3">
<h3 class="anchored" data-anchor-id="pearson-residuals-normalization">Pearson residuals normalization</h3>
<p>As suggested in the Lause et al 2021 https://genomebiology.biomedcentral.com/articles/10.1186/s13059-021-02451-7</p>
<div id="cell-93" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># revert back to counts</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'raw'</span>].copy()</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>sc.experimental.pp.normalize_pearson_residuals(adata)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Now the X matrix is an array instead.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP pearson R'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-95" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_umap_pearson'</span>] <span class="op">=</span> adata.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'leiden_pearson'</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'pearson'</span>] <span class="op">=</span> adata.X.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Select one high, one low and one intermediate expression gene and plot expression distributions.</p>
<div id="cell-97" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Cst3'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">"Cst3 vs Total counts"</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Cd69'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">"Cd69 vs Total counts"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X[:,adata.var.index.tolist().index(<span class="st">'Sorl1'</span>)], c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">"Sorl1 vs Total counts"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>Text(0.5, 1.0, 'Sorl1 vs Total counts')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-59-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-98" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/preprocessing/_normalization.py:234: UserWarning: Some cells have zero counts
  warn(UserWarning("Some cells have zero counts"))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-60-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cell-size-normalization" class="level3">
<h3 class="anchored" data-anchor-id="cell-size-normalization">Cell size normalization</h3>
<div id="cell-100" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> adata.layers[<span class="st">'raw'</span>].copy()</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>Xnorm <span class="op">=</span> np.divide(X.todense().T, adata.obs[<span class="st">'cell_area'</span>].values).T <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># need to add a scaling factor?</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>Xnorm <span class="op">=</span> np.log1p(Xnorm)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> sparse</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> sparse.csr_matrix(Xnorm.copy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-101" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP size norm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Cst3'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">"Cst3 vs Total counts"</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Cd69'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">"Cd69 vs Total counts"</span>)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].scatter(adata.obs[<span class="st">'total_counts'</span>], adata.X.getcol(adata.var.index.tolist().index(<span class="st">'Sorl1'</span>)).toarray(), c<span class="op">=</span>adata.obs[<span class="st">'n_genes'</span>],alpha<span class="op">=</span><span class="fl">0.5</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">"Sorl1 vs Total counts"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>Text(0.5, 1.0, 'Sorl1 vs Total counts')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-63-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-103" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_umap_size'</span>] <span class="op">=</span> adata.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'leiden_size'</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'size'</span>] <span class="op">=</span> adata.X.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-104" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all with clustering from lognorm coloring.</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, basis<span class="op">=</span><span class="st">'umap_counts'</span>, title<span class="op">=</span><span class="st">'umap counts'</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, basis<span class="op">=</span><span class="st">'umap_lognorm'</span>, title<span class="op">=</span><span class="st">'umap lognorm'</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>) </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, basis<span class="op">=</span><span class="st">'umap_scaled'</span>, title<span class="op">=</span><span class="st">'umap scaled'</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">2</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, basis<span class="op">=</span><span class="st">'umap_pearson'</span>, title<span class="op">=</span><span class="st">'umap pearson'</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, basis<span class="op">=</span><span class="st">'umap_size'</span>, title<span class="op">=</span><span class="st">'umap size norm'</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata, color<span class="op">=</span><span class="st">'leiden_pearson'</span>, basis<span class="op">=</span><span class="st">'umap_pearson'</span>, title<span class="op">=</span><span class="st">'umap pearson, cl pearson'</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">2</span>], show<span class="op">=</span><span class="va">False</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-65-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>lognorm clusters 0,1,5,16 now 0,4,20 with pearson.</p>
<p>Cortical layers are 9,3,10,22,8 in lognorm, 12,8,9,17,16,27,30,25 in pearson</p>
<p>New pearson clusters 28, 19, 29, 26, 25,30, (pretty much all abouve 25)</p>
<div id="cell-106" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all with same colors to make more comparable.</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Lognorm"</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden_scaled'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Scaled"</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Pearson"</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden_size'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Size"</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-66-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-66-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-66-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-66-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Better separation of cortical layers with Size or Pearson normalization.</p>
<div id="cell-108" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># examine specific clusters that differen between lognorm and pearson</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>clustersL <span class="op">=</span> adata.obs[<span class="st">'leiden_lognorm'</span>].cat.categories.tolist()</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>clustersP <span class="op">=</span> adata.obs[<span class="st">'leiden_pearson'</span>].cat.categories.tolist()</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">#lognorm clusters 0,15,16 now 0,4,20 with pearson.</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">#New pearson clusters  28, 19, 29, 26, 25,30, (pretty much all abouve 25)</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_lognorm'</span>].isin(np.array(clustersL)[[<span class="dv">0</span>,<span class="dv">15</span>,<span class="dv">16</span>]]),:], color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_pearson'</span>].isin(np.array(clustersP)[[<span class="dv">0</span>,<span class="dv">4</span>,<span class="dv">20</span>]]),:], color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_pearson'</span>].isin(clustersP[<span class="dv">25</span>:<span class="dv">29</span>]),:], color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_pearson'</span>].isin(clustersP[<span class="dv">29</span>:<span class="dv">33</span>]),:], color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-67-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-109" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Cortical layers are 9,3,10,22,8 in lognorm, 12,8,9,17,16,27,30,25 in pearson</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_lognorm'</span>].isin(np.array(clustersL)[[<span class="dv">9</span>,<span class="dv">3</span>]]),:], color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_lognorm'</span>].isin(np.array(clustersL)[[<span class="dv">10</span>,<span class="dv">22</span>,<span class="dv">8</span>]]),:], color<span class="op">=</span><span class="st">'leiden_lognorm'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>, palette <span class="op">=</span> adata.uns[<span class="st">'leiden_pearson_colors'</span>])</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_pearson'</span>].isin(np.array(clustersP)[[<span class="dv">12</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">17</span>]]),:], color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden_pearson'</span>].isin(np.array(clustersP)[[<span class="dv">16</span>,<span class="dv">27</span>,<span class="dv">30</span>,<span class="dv">25</span>]]),:], color<span class="op">=</span><span class="st">'leiden_pearson'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># cl 22 is a low quality cluster with lognorm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-68-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-110" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'total_counts'</span>, groupby<span class="op">=</span><span class="st">'leiden_lognorm'</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'total_counts'</span>, groupby<span class="op">=</span><span class="st">'leiden_scaled'</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'total_counts'</span>, groupby<span class="op">=</span><span class="st">'leiden_pearson'</span>)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'total_counts'</span>, groupby<span class="op">=</span><span class="st">'leiden_size'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-69-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-69-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-69-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-69-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="dimensionality-reduction" class="level2">
<h2 class="anchored" data-anchor-id="dimensionality-reduction">Dimensionality reduction</h2>
<p>We use dimensionality reduction, clustering, and visualization techniques to analyze the structure of our dataset, group similar cells, and visualize their relationships. First, we apply Principal Component Analysis (PCA) to reduce the high-dimensional gene expression data into a smaller set of principal components, retaining the main patterns of variation while reducing noise. Then, we create a neighbors graph, which identifies connections between cells based on their similarity in the reduced PCA space, capturing local relationships essential for clustering. Using the Leiden clustering algorithm, we group cells into clusters based on these connections, allowing us to identify groups of similar cells that may represent distinct cell types or states. We then apply UMAP (Uniform Manifold Approximation and Projection), a technique that reduces the data to two dimensions for visualization, preserving both local and global structures in the data. Finally, we generate a UMAP plot with cells colored by their assigned clusters, providing an overview of the dataset’s structure and making it easy to spot distinct cell populations or clusters. This visualization gives us an interpretable view of the relationships within our data, helping us understand its organization before further analysis.</p>
<div id="cell-114" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run for now with scaled.</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'scaled'</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-115" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-116" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP before filtering suspected false positives'</span>, legend_loc<span class="op">=</span><span class="st">'on data'</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co">#help(sc.pl.umap)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-72-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-117" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-73-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can plot clusters spatially to see if they are localized to specific regions of the tissue, which may indicate spatially distinct cell types or states. This spatial information can provide insights into the organization of cells within the tissue and help identify spatially related cell populations or structures.</p>
<div id="cell-119" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>].cat.categories.tolist()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">0</span>:<span class="dv">3</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">3</span>:<span class="dv">6</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">6</span>:<span class="dv">9</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">9</span>:<span class="dv">12</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-74-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-120" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">12</span>:<span class="dv">15</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">15</span>:<span class="dv">18</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">18</span>:<span class="dv">21</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">21</span>:<span class="dv">24</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-75-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-121" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">24</span>:<span class="dv">27</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">27</span>:<span class="dv">30</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata[adata.obs[<span class="st">'leiden'</span>].isin(clusters[<span class="dv">30</span>:<span class="dv">33</span>]),:], color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list
/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scanpy/plotting/_utils.py:487: ImplicitModificationWarning: Trying to modify attribute `._uns` of view, initializing view as actual.
  adata.uns[value_to_plot + "_colors"] = colors_list</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-76-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Using vioilin plots to see how the clusters are distributed in terms of gene expression (number of genes and the total counts) and cell size (cell and nucleus area). This helps us understand the characteristics of each cluster in terms of gene expression levels, cell size, and other features, providing insights into the biological properties of each cluster.</p>
<div id="cell-123" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">"total_counts"</span>,<span class="st">"n_genes"</span>], groupby<span class="op">=</span><span class="st">'leiden'</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">"nucleus_area"</span>,<span class="st">"cell_area"</span>], groupby<span class="op">=</span><span class="st">'leiden'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-77-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-77-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Explore QC a bit more</p>
<div id="cell-125" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'total_counts'</span>, show<span class="op">=</span><span class="va">False</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'n_genes'</span>, show<span class="op">=</span><span class="va">False</span>, ax <span class="op">=</span> axs[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'nucleus_area'</span>, show<span class="op">=</span><span class="va">False</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'cell_area'</span>, show<span class="op">=</span><span class="va">False</span>, ax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="systematic-filtering-of-suspected-false-positives" class="level2">
<h2 class="anchored" data-anchor-id="systematic-filtering-of-suspected-false-positives">Systematic Filtering of Suspected False Positives</h2>
<p>In Xenium data, some genes may appear to be “expressed” across large areas or in many cells due to background noise or technical artifacts, rather than true biological expression. To address this, we are implementing a gene-specific filtering approach to identify and remove suspected false positives systematically. By filtering out these spurious signals, we can focus our analysis on more reliable gene expression patterns, improving the quality of downstream analyses.</p>
<section id="calculate-the-mean-expression-per-gene-per-cluster" class="level4">
<h4 class="anchored" data-anchor-id="calculate-the-mean-expression-per-gene-per-cluster">1- Calculate the Mean Expression per Gene per Cluster</h4>
<p>In the first step, we calculate the mean expression of each gene within each cluster. Clustering organizes cells into groups that likely share biological characteristics, and taking the average expression of each gene within clusters provides a baseline for typical expression levels. This allows us to identify clusters where a gene has unusually low expression, which might indicate noise rather than true expression.</p>
<div id="cell-128" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>mean_expression <span class="op">=</span> adata.to_df().groupby(adata.obs[<span class="st">'leiden'</span>]).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/8l/yj6nz8296zd7wwj0xy6pw3880000gn/T/ipykernel_80568/2069805196.py:1: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  mean_expression = adata.to_df().groupby(adata.obs['leiden']).mean()</code></pre>
</div>
</div>
</section>
<section id="determine-the-maximum-expression-level-of-each-gene-across-clusters" class="level4">
<h4 class="anchored" data-anchor-id="determine-the-maximum-expression-level-of-each-gene-across-clusters">2- Determine the Maximum Expression Level of Each Gene Across Clusters</h4>
<p>Then, we find the maximum expression level for each gene across all clusters. This maximum value serves as a reference point for each gene’s typical expression level in the dataset. The highest expression level of each gene is assumed to represent meaningful expression, while lower values may be more likely to represent noise or background.</p>
<div id="cell-130" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>max_expression_levels <span class="op">=</span> mean_expression.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-spurious-expression-threshold-for-each-gene" class="level4">
<h4 class="anchored" data-anchor-id="calculate-spurious-expression-threshold-for-each-gene">3- Calculate Spurious Expression Threshold for Each Gene</h4>
<p>We define a threshold, here set at 5%, which will be used to identify potential false positives. This threshold means that if a gene’s expression in a given cluster is below 5% of its highest expression level across all clusters, we will consider it to be a likely false positive. This step allows us to systematically identify clusters where the gene’s expression is likely due to background noise rather than true biological signal. Then, we calculate a <code>spurious expression threshold</code> for each gene, which is 5% of its maximum expression level. This threshold provides a cut-off below which we consider expression values to be suspected false positives. By applying this threshold, we can filter out clusters where a gene’s expression level is unlikely to be biologically meaningful.</p>
<div id="cell-132" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>spurious_expression_threshold <span class="op">=</span> max_expression_levels <span class="op">*</span> threshold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-133" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot distribution for first few genes.</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene <span class="kw">in</span> adata.var_names[:<span class="dv">10</span>]: </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    cut <span class="op">=</span> spurious_expression_threshold[gene]</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    sc.pl.violin(adata, gene, groupby<span class="op">=</span><span class="st">'leiden'</span>, use_raw<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>, ylabel <span class="op">=</span> <span class="bu">str</span>(cut))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    sns.barplot(mean_expression[gene], ax<span class="op">=</span>axs[<span class="dv">1</span>])</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span>cut, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(gene, <span class="st">":"</span>,cut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2010300C02Rik : 0.08079957
Abca7 : 0.042234458
Acsbg1 : 0.058632173
Acta2 : 0.06602961
Acvrl1 : 0.098840825
Adamts2 : 0.06141582
Adamtsl1 : 0.08577509
Adgrl4 : 0.1225271
Aldh1a2 : 0.16123967
Aldh1l1 : 0.04846475</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-82-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="identify-suspected-false-positives-for-each-cluster-and-gene" class="level4">
<h4 class="anchored" data-anchor-id="identify-suspected-false-positives-for-each-cluster-and-gene">4- Identify Suspected False Positives for Each Cluster and Gene</h4>
<p>Next we creat a dictionary, <code>suspected_false_positives</code>, to store suspected false positive genes for each cluster. For each cluster, it checks each gene’s mean expression level within that cluster. If the gene’s mean expression is below the spurious expression threshold (5% of its maximum expression), the gene is flagged as a suspected false positive in that cluster.</p>
<div id="cell-135" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>suspected_false_positives <span class="op">=</span> {}</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster <span class="kw">in</span> mean_expression.index:</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    suspected_genes <span class="op">=</span> []</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gene <span class="kw">in</span> adata.var_names:</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mean_expression.at[cluster, gene] <span class="op">&lt;</span> spurious_expression_threshold[gene]:</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>            suspected_genes.append(gene)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    suspected_false_positives[cluster] <span class="op">=</span> suspected_genes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can see a quick summary of the suspected false positives across clusters</p>
<div id="cell-137" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Showing first 10 genes for brevity</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster, genes <span class="kw">in</span> suspected_false_positives.items():</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cluster </span><span class="sc">{</span>cluster<span class="sc">}</span><span class="ss"> has </span><span class="sc">{</span><span class="bu">len</span>(genes)<span class="sc">}</span><span class="ss"> suspected false positive genes: </span><span class="sc">{</span>genes[:<span class="dv">10</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>cluster_counts <span class="op">=</span> {cluster: <span class="bu">len</span>(genes) <span class="cf">for</span> cluster, genes <span class="kw">in</span> suspected_false_positives.items()}</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> <span class="bu">list</span>(cluster_counts.keys())</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> <span class="bu">list</span>(cluster_counts.values())</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>clusters, y<span class="op">=</span>counts, palette<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Suspected False Positive Genes per Cluster'</span>)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Cluster'</span>)</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Count of Suspected False Positive Genes'</span>)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster 0 has 315 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 1 has 289 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Ano1', 'Apod']
Cluster 2 has 218 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 3 has 278 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1']
Cluster 4 has 296 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acta2', 'Adamts2', 'Adamtsl1', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1', 'Apod']
Cluster 5 has 258 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Adamtsl1', 'Aldh1l1', 'Aqp4', 'Arc', 'Arhgap12', 'Arhgap25', 'Arhgap6']
Cluster 6 has 239 suspected false positive genes: ['2010300C02Rik', 'Acta2', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Apoe']
Cluster 7 has 260 suspected false positive genes: ['Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Angpt1', 'Ano1', 'Apod']
Cluster 8 has 236 suspected false positive genes: ['Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Angpt1', 'Ano1', 'Apod', 'Apoe']
Cluster 9 has 288 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Ano1', 'Apod']
Cluster 10 has 237 suspected false positive genes: ['Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1', 'Apod']
Cluster 11 has 221 suspected false positive genes: ['Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Apoe']
Cluster 12 has 282 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acta2', 'Acvrl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1', 'Aqp4']
Cluster 13 has 273 suspected false positive genes: ['Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1']
Cluster 14 has 261 suspected false positive genes: ['Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 15 has 276 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1']
Cluster 16 has 210 suspected false positive genes: ['Acsbg1', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Ano1', 'Apod', 'Apoe', 'Aqp4', 'Arhgap12']
Cluster 17 has 280 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 18 has 224 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 19 has 269 suspected false positive genes: ['Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']
Cluster 20 has 283 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1']
Cluster 21 has 283 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Adamts2', 'Adamtsl1', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Apod', 'Aqp4', 'Arc']
Cluster 22 has 222 suspected false positive genes: ['Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Apoe']
Cluster 23 has 211 suspected false positive genes: ['Abca7', 'Acsbg1', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Apoe']
Cluster 24 has 221 suspected false positive genes: ['2010300C02Rik', 'Acta2', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Aqp4']
Cluster 25 has 253 suspected false positive genes: ['Acsbg1', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Ano1', 'Apod', 'Apoe', 'Aqp4']
Cluster 26 has 207 suspected false positive genes: ['Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Angpt1', 'Ano1', 'Apod', 'Apoe', 'Aqp4', 'Arhgap25']
Cluster 27 has 238 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1l1', 'Angpt1', 'Ano1']
Cluster 28 has 275 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1']
Cluster 29 has 287 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Apod']
Cluster 30 has 256 suspected false positive genes: ['2010300C02Rik', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamtsl1', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1', 'Ano1']
Cluster 31 has 307 suspected false positive genes: ['2010300C02Rik', 'Abca7', 'Acsbg1', 'Acta2', 'Acvrl1', 'Adamts2', 'Adgrl4', 'Aldh1a2', 'Aldh1l1', 'Angpt1']</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/8l/yj6nz8296zd7wwj0xy6pw3880000gn/T/ipykernel_80568/225620550.py:9: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.barplot(x=clusters, y=counts, palette='viridis')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-84-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Clusters 8,14,20,21 have very small cell areas. 8 also small nucleus area, small number of genes and counts. Clusters 14,20,21 has the highest number of FP genes.</p>
<p>Due to low numbers mainly?</p>
<p>Clusters in tissue:</p>
<div id="cell-139" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sc.pl.spatial(adata, color='n_genes')</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'cell_area'</span>,<span class="st">'nucleus_area'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Cell Area"</span>, color_map <span class="op">=</span> <span class="st">"viridis_r"</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[<span class="st">'total_counts'</span>,<span class="st">'n_genes'</span>], spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Cell Area"</span>, color_map <span class="op">=</span> <span class="st">"viridis_r"</span>)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span><span class="st">'leiden'</span>, spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="st">"Clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: The title list is shorter than the number of panels. Using 'color' value instead for some plots.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-85-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: The title list is shorter than the number of panels. Using 'color' value instead for some plots.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-85-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-85-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-140" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>all_suspected_fp_genes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> genes <span class="kw">in</span> suspected_false_positives.values():</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    all_suspected_fp_genes.update(genes)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>all_suspected_fp_genes_list <span class="op">=</span> <span class="bu">sorted</span>(all_suspected_fp_genes)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> <span class="bu">list</span>(suspected_false_positives.keys())</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="op">=</span> pd.DataFrame(<span class="dv">0</span>, index<span class="op">=</span><span class="bu">list</span>(all_suspected_fp_genes_list), columns<span class="op">=</span>clusters)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster, genes <span class="kw">in</span> suspected_false_positives.items():</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    heatmap_data.loc[genes, cluster] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(heatmap_data, cmap<span class="op">=</span><span class="st">"viridis"</span>, cbar_kws<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Presence of Suspected False Positives'</span>})</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Heatmap of Suspected False Positive Genes Across Clusters"</span>)</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Cluster"</span>)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Gene"</span>)</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-86-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-141" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>background_noise_counts <span class="op">=</span> {gene: <span class="dv">0</span> <span class="cf">for</span> gene <span class="kw">in</span> adata.var_names}</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene <span class="kw">in</span> adata.var_names:</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster <span class="kw">in</span> mean_expression.index:</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mean_expression.at[cluster, gene] <span class="op">&lt;</span> spurious_expression_threshold[gene]:</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>            background_noise_counts[gene] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the gene with the highest background noise</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>highest_noise_gene <span class="op">=</span> <span class="bu">max</span>(background_noise_counts, key<span class="op">=</span>background_noise_counts.get)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>highest_noise_count <span class="op">=</span> background_noise_counts[highest_noise_gene]</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The gene with the highest background noise is '</span><span class="sc">{</span>highest_noise_gene<span class="sc">}</span><span class="ss">', detected below the threshold in </span><span class="sc">{</span>highest_noise_count<span class="sc">}</span><span class="ss"> clusters."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The gene with the highest background noise is 'C1qa', detected below the threshold in 31 clusters.</code></pre>
</div>
</div>
</section>
<section id="adjusting-gene-expression-values-across-the-dataset-background-noise-reduction" class="level4">
<h4 class="anchored" data-anchor-id="adjusting-gene-expression-values-across-the-dataset-background-noise-reduction">5- Adjusting gene expression values across the dataset (background noise reduction)</h4>
<p>Now, we aim to reduce background noise by adjusting gene expression levels across all cells based on suspected false positives. Specifically, if a gene has low expression (below the spurious expression threshold) in any cluster, we take the highest of those low expression levels and subtract it from all cells for that gene. This method removes unspecific, potentially spurious expression, which can help improve cluster separation and make biologically relevant expression patterns clearer.</p>
<div id="cell-143" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>adata_app_1 <span class="op">=</span> adata.copy()</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>max_filtered_expression <span class="op">=</span> {}</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>adata_df <span class="op">=</span> adata_app_1.to_df()</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene <span class="kw">in</span> adata_app_1.var_names:</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    below_threshold_values <span class="op">=</span> []</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster <span class="kw">in</span> mean_expression.index:</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>        expression_level <span class="op">=</span> mean_expression.at[cluster, gene]</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expression_level <span class="op">&lt;</span> spurious_expression_threshold[gene]:</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>            below_threshold_values.append(expression_level)</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> below_threshold_values:</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        max_filtered_expression[gene] <span class="op">=</span> <span class="bu">max</span>(below_threshold_values)</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>        max_filtered_expression[gene] <span class="op">=</span> <span class="dv">0</span>  </span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">#no values below threshold = no subtraction needed</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a><span class="co">#subtract the maximum filtered expression value from all cells for each gene</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene <span class="kw">in</span> adata_app_1.var_names:</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>    max_expr <span class="op">=</span> max_filtered_expression[gene]</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> max_expr <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>        adata_df[gene] <span class="op">-=</span> max_expr</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ensure that no negative values are introduced</span></span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>        adata_df[gene] <span class="op">=</span> np.maximum(adata_df[gene], <span class="dv">0</span>)</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a><span class="co">#update AnnData object with adjusted gene expressions</span></span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>adata_app_1 <span class="op">=</span> sc.AnnData(X<span class="op">=</span>adata_df.values, obs<span class="op">=</span>adata_app_1.obs, var<span class="op">=</span>adata_app_1.var, obsm<span class="op">=</span>adata_app_1.obsm)</span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata_app_1)</span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata_app_1)</span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata_app_1)</span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata_app_1)</span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-144" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>adata_app_1.obs[<span class="st">"old_clust"</span>] <span class="op">=</span> adata.obs[<span class="st">'leiden'</span>]</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">"new_clust"</span>] <span class="op">=</span> adata_app_1.obs[<span class="st">'leiden'</span>]</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata_app_1, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP after filtering, clusters after filtering'</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata_app_1, color<span class="op">=</span><span class="st">'old_clust'</span>, title<span class="op">=</span><span class="st">'UMAP after filtering, clusters before filtering'</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'new_clust'</span>, title<span class="op">=</span><span class="st">'UMAP before filtering, clusters after filtering'</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP before filtering, clusters before filtering'</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-89-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Mainly cluster 11 clearly moves from middle part to top left.</p>
<div id="cell-146" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>normalized_counts1 <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>normalized_counts2 <span class="op">=</span> adata_app_1.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(np.array(normalized_counts1), normalized_counts2, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Sum expression before filtering"</span>)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Sum expression after filtering"</span>)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Expression sum after filtering"</span>)</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-90-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-147" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Vip"</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[gene_of_interest], spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Expression Before Adjustment'</span>, color_map<span class="op">=</span><span class="st">'viridis_r'</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata_app_1, color<span class="op">=</span>[gene_of_interest], spot_size<span class="op">=</span><span class="dv">15</span>, title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Expression After Adjustment'</span>, color_map <span class="op">=</span> <span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-91-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-148" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>original_expression <span class="op">=</span> adata.to_df()[gene_of_interest]</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>adjusted_expression <span class="op">=</span> adata_app_1.to_df()[gene_of_interest]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(original_expression, label<span class="op">=</span><span class="st">"Original"</span>, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(adjusted_expression, label<span class="op">=</span><span class="st">"Adjusted"</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="ss">f'Expression of </span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Expression Distribution of </span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Before and After Adjustment'</span>)</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-92-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-149" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean expression per gene</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>mean_expression_original <span class="op">=</span> adata.to_df().mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>mean_expression_adjusted <span class="op">=</span> adata_app_1.to_df().mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a scatter plot comparing mean expression before and after adjustment</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>plt.scatter(mean_expression_original, mean_expression_adjusted, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="bu">max</span>(mean_expression_original)], [<span class="dv">0</span>, <span class="bu">max</span>(mean_expression_adjusted)], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Mean Expression (Original)'</span>)</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean Expression (Adjusted)'</span>)</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Mean Gene Expression Before and After Adjustment'</span>)</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-93-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="second-approach" class="level3">
<h3 class="anchored" data-anchor-id="second-approach">Second approach</h3>
<p>Check the histogram of the gene expression for every gene and if it has a multimodal expression distribution to set based on that histogram a thereshold below which we consider the expression to be background. And we could remove from all cells the expression below that therahold. First making helper functions performing dip test and plotting the histogram of the gene expression. I’ve used dip test to check if the distribution is multimodal or not. If the p-value is smaller than 0.05 we consider the distribution to be multimodal. A question here would be that should we only consider non-zero expression values for this analysis or should we consider all expression values? If consider all values we might get a multimodal distribution all for genes, however if we only consider non-zero values we might miss some genes that are suspected to have multimodal distribution. What do you think?</p>
<div id="cell-151" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>genes_to_analyze <span class="op">=</span> adata.var_names[<span class="dv">0</span>:<span class="bu">len</span>(adata.var_names)]</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> {}</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene <span class="kw">in</span> genes_to_analyze:</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> hf.analyze_gene_expressions(adata, gene, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">False</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> threshold <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        thresholds[gene] <span class="op">=</span> threshold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sort genes by threshold values in descending order and display the top genes with the highest thresholds</p>
<div id="cell-153" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>sorted_thresholds <span class="op">=</span> <span class="bu">sorted</span>(thresholds.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top genes with the highest thresholds:"</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene, threshold_value <span class="kw">in</span> sorted_thresholds[:<span class="dv">10</span>]:</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>gene<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>threshold_value<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top genes with the highest thresholds:
C3: 9.797229191085119
Crh: 9.30170339008083
Tgm1: 9.151178239165127
Ptx3: 9.081075215714053
Th: 7.629701487384401
Cxcl10: 7.478884432901133
Pln: 7.468555342402305
Itgax: 7.4166006570284795
Il1a: 7.1395792748119025
Chodl: 7.0284665207992925</code></pre>
</div>
</div>
<div id="cell-154" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>hf.analyze_gene_expressions(adata, gene_of_interest, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">True</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-96-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Calb1 has a Multimodal modality (p-value=0.00)
Background threshold for Calb1 is 1.498</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>1.498341975269375</code></pre>
</div>
</div>
<div id="cell-155" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'lognorm'</span>].copy()</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>hf.analyze_gene_expressions(adata, gene_of_interest, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">True</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-97-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Calb1 has a Multimodal modality (p-value=0.00)
Background threshold for Calb1 is 5.090</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>5.089991098886973</code></pre>
</div>
</div>
<div id="cell-156" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'scaled'</span>].copy()</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>hf.analyze_gene_expressions(adata, gene_of_interest, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">True</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-98-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Calb1 has a Multimodal modality (p-value=0.00)
Background threshold for Calb1 is 1.498</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>1.498341975269375</code></pre>
</div>
</div>
<div id="cell-157" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'pearson'</span>].copy()</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>hf.analyze_gene_expressions(adata, gene_of_interest, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">True</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-99-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Calb1 has a Unimodal modality (p-value=0.19)</code></pre>
</div>
</div>
<div id="cell-158" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>adata.X <span class="op">=</span> adata.layers[<span class="st">'size'</span>].copy()</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>hf.analyze_gene_expressions(adata, gene_of_interest, bandwidth<span class="op">=</span><span class="fl">0.05</span>, plot<span class="op">=</span><span class="va">True</span>, filter_zeros<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-100-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Calb1 has a Multimodal modality (p-value=0.00)
Background threshold for Calb1 is 0.391</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>0.39147009018736884</code></pre>
</div>
</div>
<p>Now we can do the subtraction of genes with a background expression from their original values in each cell.</p>
<div id="cell-160" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Reverse the log1p transformation on adata.X</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>adata_app_2 <span class="op">=</span> adata.copy()</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> sp.issparse(adata_app_2.X):</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    adata_app_2.X <span class="op">=</span> sp.csr_matrix(np.expm1(adata_app_2.X.toarray()))</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    adata_app_2.X <span class="op">=</span> np.expm1(adata_app_2.X)</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Reverse the log1p transformation on thresholds</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> {gene: np.expm1(thresh) <span class="cf">for</span> gene, thresh <span class="kw">in</span> thresholds.items()}</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Perform the subtraction and ensure non-negative values</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gene, threshold <span class="kw">in</span> thresholds.items():</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gene <span class="kw">in</span> adata_app_2.var_names:  <span class="co"># Ensure the gene exists in adata</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>        gene_index <span class="op">=</span> adata_app_2.var_names.get_loc(gene)</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the column as a dense numpy array</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>        gene_data <span class="op">=</span> adata_app_2[:, gene].X</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp.issparse(gene_data):</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>            gene_data <span class="op">=</span> gene_data.toarray().flatten()</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Perform the subtraction and ensure non-negative values</span></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>        updated_gene_data <span class="op">=</span> np.maximum(gene_data <span class="op">-</span> threshold, <span class="dv">0</span>)</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the AnnData object</span></span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp.issparse(adata_app_2.X):</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>            adata_app_2[:, gene_index].X <span class="op">=</span> sp.csr_matrix(updated_gene_data[:, np.newaxis])</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>            adata_app_2[:, gene_index].X <span class="op">=</span> updated_gene_data[:, np.newaxis]</span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Reapply the log1p transformation</span></span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata_app_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/rasools/miniconda3/envs/imaging_based_data_analysis_env/lib/python3.9/site-packages/scipy/sparse/_index.py:142: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray_sparse(i, j, x)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: adata.X seems to be already log-transformed.</code></pre>
</div>
</div>
<div id="cell-161" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>gene_of_interest <span class="op">=</span> <span class="st">"Calb1"</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata, color<span class="op">=</span>[gene_of_interest], spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Expression Before Adjustment'</span>, color_map <span class="op">=</span> <span class="st">'viridis_r'</span>)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>sc.pl.spatial(adata_app_2, color<span class="op">=</span>[gene_of_interest], spot_size<span class="op">=</span><span class="dv">10</span>, title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Expression After Adjustment'</span>, color_map <span class="op">=</span> <span class="st">'viridis_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-102-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-102-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-162" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>original_expression <span class="op">=</span> adata.to_df()[gene_of_interest]</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>adjusted_expression <span class="op">=</span> adata_app_2.to_df()[gene_of_interest]</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot expression distributions</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(original_expression, label<span class="op">=</span><span class="st">"Original"</span>, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(adjusted_expression, label<span class="op">=</span><span class="st">"Adjusted"</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="ss">f'Expression of </span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Expression Distribution of </span><span class="sc">{</span>gene_of_interest<span class="sc">}</span><span class="ss"> Before and After Adjustment'</span>)</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-103-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-163" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Principal component analysis for dimension reduction</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata_app_2)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata_app_2)</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata_app_2)</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata_app_2)</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata_app_2, color<span class="op">=</span><span class="st">'leiden'</span>, title<span class="op">=</span><span class="st">'UMAP after filtering suspected false positives (approach 2)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="p1_qc_normalization_files/figure-html/cell-104-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/elixir-europe-training\.github\.io\/ELIXIR-SCO-spatial-omics\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>